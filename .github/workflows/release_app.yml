name: 'publish'
on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
jobs:  
  build-app:
    runs-on: ${{ matrix.os }}
    name: Build ${{ matrix.platform }}
    strategy:
      matrix:
        platform: [ios, android]
        include:
          - platform: ios
            os: its-macos
          - platform: android
            os: its-linux

    steps:
      - uses: actions/checkout@v4
      
      - name: Setup environment (node, pnpm, expo)
        uses: ./.github/workflows/setup
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      
      - name: Set private eas.json (iOS only)
        if: matrix.platform == 'ios'
        run: echo '${{ secrets.EAS_JSON }}' > eas.json
        
      - name: ðŸš€ Build app
        run: |
          RELEASE_VERSION=${{ github.ref_name }} eas build --platform ${{ matrix.platform }} --non-interactive --local

      - name: Submit to App Store (iOS only)
        if: ${{ github.event.inputs.submit_ios == 'yes' && matrix.platform == 'ios' }}
        run: eas submit --platform ios --path build* 

      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%d-%m-%Y')"

      - name: ðŸ“Œ Nextcloud Artifact
        uses: trympet/nextcloud-artifacts-action@v2
        with:
          # include the platform and date in the filename
          name: ${{ matrix.platform }}-${{ github.ref_name }}-${{ steps.date.outputs.date }}
          path: build-*                                         
          nextcloud-url: ${{ secrets.NEXTCLOUD_URL }}           
          nextcloud-username: ${{ secrets.NEXTCLOUD_USERNAME }} 
          nextcloud-password: ${{ secrets.NEXTCLOUD_PASSWORD }} 