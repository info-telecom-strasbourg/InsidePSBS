name: 'publish'
on:
  workflow_dispatch:
    inputs:
      submit_ios:
        description: 'Submit iOS build'
        type: choice
        options:
          - 'yes'
          - 'false'
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
jobs:  
  build-app:
    runs-on: ${{ matrix.os }}
    name: Build ${{ matrix.platform }}
    strategy:
      matrix:
        platform: [ios, android]
        include:
          - platform: ios
            os: its-macos
          - platform: android
            os: its-linux

    steps:
      - uses: actions/checkout@v4
      
      - name: Setup environment (node, pnpm, expo)
        uses: ./.github/workflows/setup
        with:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      
      - name: Set private eas.json (iOS only)
        if: matrix.platform == 'ios'
        run: echo '${{ secrets.EAS_JSON }}' > eas.json
        
      - name: ðŸš€ Build app
        run: |
          RELEASE_VERSION=${{ github.ref_name }} eas build --platform ${{ matrix.platform }} --non-interactive --local

      - name: Submit to App Store (iOS only)
        if: ${{ github.event.inputs.submit_ios == 'yes' && matrix.platform == 'ios' }}
        run: eas submit --platform ios --path build* 

      - name: ðŸ“Œ Nextcloud Artifact
        uses: trympet/nextcloud-artifacts-action@v2
        with:
          name: ${{ matrix.platform == 'ios' && 'app-ipa' || 'app-aab' }}
          path: build-*                                         
          nextcloud-url: ${{ secrets.NEXTCLOUD_URL }}           
          nextcloud-username: ${{ secrets.NEXTCLOUD_USERNAME }} 
          nextcloud-password: ${{ secrets.NEXTCLOUD_PASSWORD }} 